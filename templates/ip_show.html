{% extends 'base.html' %}
  {% block content %}

  {% set g = geocoder.ip(ip) %}


<style>
.nmap-output {
background-color: #1e1e1e;
color: #d4d4d4;
padding: 1.5em;
border-radius: 5px;
font-family: 'Courier New', Courier, monospace;
font-size: 0.9em;
white-space: pre-wrap; /* Wrap long lines */
word-break: break-all;
max-height: 500px;
overflow-y: auto;
border: 1px solid #333;
}
</style>

<!-- Breadcrumb Navigation -->
<div class="ui breadcrumb">
  <a class="section" href="/">List of IPs</a>
  <i class="right angle icon divider"></i>
  <div class="active section">{{ip}}</div>
</div>

<!-- IP Address Details Card -->
<div class="ui segment" style="margin-top: 1em;">
  <h2 class="ui header">
    <i class="sitemap icon"></i>
    <div class="content">
      {{ip}}
      <div class="sub header">Details for this specific IP address.</div>
    </div>
  </h2>
  <div class="ui list">
    <div class="item">
      <i class="globe icon"></i>
      <div class="content">
        <strong>City:</strong> 
        <img src="https://flagcdn.com/w20/{{g.country | lower}}.png" class="flag-icon"> {{g.city | capitalize}}
      </div>
    </div>
    <div class="item">
      <i class="building icon"></i>
      <div class="content"><strong>ASN:</strong> AS133655 FPT Telecom Company</div>
    </div>
  </div>
</div>


<!-- NMAP Scan Output -->
<h3 class="ui header">Nmap Scan Output</h3>
<div class="nmap-output">
  <pre>{{scan.decode() | trim}}</pre>
</div>


<div class="ui top attached tabular menu">
  <a class="active item" data-tab="sessions"> <i class="history icon"></i> Sessions     <div class="ui tiny red label">{{sessions | length}}</div>
</a>
  <a class="item" data-tab="files"> <i class="download icon"></i>Files <div class="ui tiny red label">{{get_files_count_for_ip(ip)}}</div></a>
  <a class="item" data-tab="urls"> <i class="globe icon"></i>URLs <div class="ui tiny red label">{{get_urls_count_for_ip(ip)}}</div></a>
  <a class="item" data-tab="credentials"><i class="lock icon"></i> Credentials</a>
</div>
<div class="ui bottom attached active tab segment" data-tab="sessions">

  <!-- Display a message if no sessions -->
  {% if not sessions %} 
  <div class="ui placeholder segment">
    <div class="ui icon header">
      <i class="history icon"></i>
      No sessions are listed for this IP.
    </div>
  </div>
  {%endif%}

  {% for session in details %}
  <div class="ui fluid active accordion">
    <div class="title">
      <i class="dropdown icon"></i>
  Session {{session.id}}
    </div>
    <div class="content">

      <div class="ui grid">
        <div class="eight wide column">
          <h3>Commands</h3>
          <div class="ui inverted segment" style="height: 90%">
            <div class="ui list">
              {% if not session.commands %}
              <p>No inputs.</p>
              {%endif%}
              {% for command in session.commands %}
              <div class="item">
                {{command.decode() | trim}}
              </div>
              {%endfor%}
            </div>
          </div>
        </div>
        <div class="eight wide column">
          <h3>Playback</h3>
          <div id="player-{{session.id}}-{{session.log_shasum}}" class="player" data-session="{{session.id}}" data-log="{{session.log_shasum}}">
          </div>
        </div>
      </div>

    </div>
  </div>
  {%endfor%}

  

</div>
<div class="ui bottom attached tab segment" data-tab="files">
  <table class="ui celled table">
    <thead>
      <tr>
        <th>Filename</th>
        <th>SHA256 Hash</th>
      </tr>
    </thead>
    <tbody>
      {% for file in details.files %}
      <tr>
        <td>
          <i class="file code outline icon"></i>
          {{file.decode().split(":")[-1]}}
        </td>
        <td><code>{{file.decode().split(":")[0]}}</code></td>
      </tr>
      {%endfor%}
    </tbody>
  </table>

</div>
<div class="ui bottom attached tab segment" data-tab="credentials">
  <table class="ui celled table">
    <thead>
      <tr>
        <th>Username</th>
        <th>Password</th>
      </tr>
    </thead>
    <tbody>
      {% for credential in details.credentials %}
      {% set data = credential.decode().split(":") %}
      <tr>
        <td>{{data[0]}}</td>
        <td><code>{{data[1]}}</code></td>
      </tr>
      {%endfor%}
    </tbody>
  </table>
</div>

<div class="ui bottom attached tab segment" data-tab="urls">
  <table class="ui celled table">
    <thead>
      <tr>
        <th>URL</th>
        <th>Shasum</th>
        <th>Session</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for session in details.sessions %}
        {% for url in session.urls %}
      {% set data = url.decode().rsplit(":", 1) %}
        <tr>
          <td>{{data[0]}}</td>
          <td>
          {% if data[1] %}
            {{data[1]}}
          {%else%}
          <a class="ui red label">Failed</a>
          {%endif%}
          </td>
          <td><code>{{session}}</code></td>
        <td>
          <a href="/files/{{data[1]}}/results?filename={{data[0]}}">View</a>
        </td>
        </tr>
        {%endfor%}
      {%endfor%}
    </tbody>
  </table>
</div>

<script>
$(document).ready(function() {
$('.player').each(function(index, element){
const session = $(element).data('session');
const log = $(element).data('log');
AsciinemaPlayer.create("/static/tty/" + log + ".rec", document.getElementById('player-' + session + "-" + log));
});
$('.ui.accordion').accordion();
$('.menu .item').tab();
});
</script>


{% endblock %}

